<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ethereum Authentication for PHP Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #web3-connect {
            background-color: #4f46e5;
            color: #fff;
            font-weight: 500;
            font-size: 14px;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #logs pre {
            padding: 6px 8px;
            border-radius: 6px;
            background: #111;
            color: #ddd;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
        }
    </style>
</head>
<body>

<div>
    <button id="web3-connect">Connect wallet</button>
</div>

<b>logs:</b>
<div id="logs"></div>

<script type="module">
    const connectButton = document.getElementById("web3-connect");
    connectButton.addEventListener("click", connectWallet);

    async function connectWallet() {
        try {
            // As an example, we interact directly with the provider via window.ethereum, but in a real project, you
            // will likely want to get a connection modal with a wallet selection. It is worth considering reown,
            // rainbow kit, or web3-onboard
            if (!window.ethereum) throw new Error("No wallet found");

            // In a real project, it would be better not to interact with the provider directly, but to use
            // viem or ethers for this purpose.
            await window.ethereum.request({method: "eth_requestAccounts"});
            const [address] = await window.ethereum.request({method: "eth_accounts"});

            // In fact, it's a question of approach. In this case, we send the address to the server to receive a
            // generated SIWE message from it. But another common option is to generate the message on the client
            // side, receiving only the nonce from the server.
            const siweMessage = (await sendRequest("/api.php?action=get_siwe_message", {address})).siwe_message;

            // To sign an SIWE message, you must use personal_sign. In viem or ethers, this is also called signMessage.
            const signature = await window.ethereum.request({
                method: "personal_sign",
                params: [siweMessage, address],
            });

            // and now we send the received signature to the server for verification
            await sendRequest("/api.php?action=authorize", {signature});
        } catch (e) {
            addLog(e.message);
        }
    }

    async function sendRequest(url, body = {}) {
        const response = await fetch(url, {
            method: "POST",
            // headers: { "Content-Type": "application/json" },
            body: new URLSearchParams(body),
        });
        const parsedResponse = await response.json();
        addLog({url, body, response: parsedResponse});

        if (parsedResponse.status !== "success") throw new Error(parsedResponse.message);
        return parsedResponse;
    }

    function addLog(args) {
        const el = document.getElementById("logs");
        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(args, null, 4);
        el.prepend(pre);
    }
</script>

</body>
</html>
